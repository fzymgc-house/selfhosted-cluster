# Environment configuration for selfhosted-cluster
# No secrets should be stored in this file - all secrets are fetched from Vault

export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES

# Vault configuration
export VAULT_ADDR=https://vault.fzymgc.house

# SOPS configuration (if using SOPS for additional encryption)
# export SOPS_AGE_KEY_FILE=~/.config/age-keys.txt

# ─────────────────────────────────────────────────────────────────────────────
# Vault Secrets Integration
# ─────────────────────────────────────────────────────────────────────────────
# Fetches API keys from Vault for Claude Code and MCP servers.
# Requires: vault login -method=oidc (run once per session)
#
# Store your API keys in Vault:
#   vault kv put secret/users/<username>/anthropic api_key=sk-ant-...
#   vault kv put secret/users/<username>/firecrawl api_key=fc-...
#   vault kv put secret/users/<username>/exa api_key=...
#   vault kv put secret/users/<username>/notion api_key=secret_...
# ─────────────────────────────────────────────────────────────────────────────

# Helper: fetch API key from Vault (silent on missing optional keys)
vault_secret() {
    local path="$1"
    local field="${2:-api_key}"
    vault kv get -field="$field" "$path" 2>/dev/null || echo ""
}

# Helper: get current Vault entity name
vault_entity_name() {
    local entity_id display_name entity_name
    entity_id=$(vault token lookup -format=json 2>/dev/null | jq -r '.data.entity_id // empty')
    if [[ -n "$entity_id" ]]; then
        entity_name=$(vault read -format=json "identity/entity/id/${entity_id}" 2>/dev/null | jq -r '.data.name // empty')
    fi
    if [[ -z "${entity_name:-}" ]]; then
        display_name=$(vault token lookup -format=json 2>/dev/null | jq -r '.data.display_name // empty')
        entity_name="${display_name#github-}"
        entity_name="${entity_name#oidc-}"
    fi
    echo "$entity_name"
}

# Only fetch secrets if authenticated to Vault
if vault token lookup &>/dev/null; then
    VAULT_ENTITY=$(vault_entity_name)
    if [[ -n "$VAULT_ENTITY" ]]; then
        # Claude Code (required)
        ANTHROPIC_API_KEY=$(vault_secret "secret/users/${VAULT_ENTITY}/anthropic")
        if [[ -n "$ANTHROPIC_API_KEY" ]]; then
            export ANTHROPIC_API_KEY
        else
            log_error "ANTHROPIC_API_KEY not found - run: bash .devcontainer/login-setup.sh"
        fi

        # MCP servers (optional)
        FIRECRAWL_API_KEY=$(vault_secret "secret/users/${VAULT_ENTITY}/firecrawl")
        [[ -n "$FIRECRAWL_API_KEY" ]] && export FIRECRAWL_API_KEY

        EXA_API_KEY=$(vault_secret "secret/users/${VAULT_ENTITY}/exa")
        [[ -n "$EXA_API_KEY" ]] && export EXA_API_KEY

        NOTION_API_KEY=$(vault_secret "secret/users/${VAULT_ENTITY}/notion")
        [[ -n "$NOTION_API_KEY" ]] && export NOTION_API_KEY
    fi
else
    log_status "Vault not authenticated - run: bash .devcontainer/login-setup.sh"
fi
