# Environment configuration for selfhosted-cluster
# No secrets should be stored in this file - all secrets are fetched from Vault

export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES

# Add scripts directory to PATH
PATH_add scripts

# Vault configuration
export VAULT_ADDR=https://vault.fzymgc.house

# SOPS configuration (if using SOPS for additional encryption)
# export SOPS_AGE_KEY_FILE=~/.config/age-keys.txt

# ─────────────────────────────────────────────────────────────────────────────
# Vault Secrets Integration (MCP Servers)
# ─────────────────────────────────────────────────────────────────────────────
# Fetches API keys from Vault for MCP servers (Firecrawl, Exa, Notion).
# Claude Code uses interactive OAuth login (claude doctor), not API keys.
#
# Note: Vault OIDC login requires localhost:8250 callback, which doesn't work
# in devcontainers. Run `vault login -method=oidc` on the host first.
#
# Store your API keys in Vault:
#   vault kv put secret/users/<username>/firecrawl api_key=fc-...
#   vault kv put secret/users/<username>/exa api_key=...
#   vault kv put secret/users/<username>/notion api_key=secret_...
# ─────────────────────────────────────────────────────────────────────────────

# Helper: fetch API key from Vault
# Errors are suppressed intentionally because:
#   1. MCP keys are optional - missing keys are normal, not errors
#   2. direnv runs on every directory change - noisy errors would be disruptive
#   3. login-setup.sh provides verbose error handling for interactive setup
vault_secret() {
    local path="$1"
    local field="${2:-api_key}"
    vault kv get -field="$field" "$path" 2>/dev/null || echo ""
}

# Helper: get current Vault entity name
vault_entity_name() {
    local entity_id display_name entity_name
    entity_id=$(vault token lookup -format=json 2>/dev/null | jq -r '.data.entity_id // empty')
    if [[ -n "$entity_id" ]]; then
        entity_name=$(vault read -format=json "identity/entity/id/${entity_id}" 2>/dev/null | jq -r '.data.name // empty')
    fi
    if [[ -z "${entity_name:-}" ]]; then
        display_name=$(vault token lookup -format=json 2>/dev/null | jq -r '.data.display_name // empty')
        entity_name="${display_name#github-}"
        entity_name="${entity_name#oidc-}"
    fi
    echo "$entity_name"
}

# Fetch MCP server API keys if authenticated to Vault
if vault token lookup &>/dev/null; then
    VAULT_ENTITY=$(vault_entity_name)
    if [[ -n "$VAULT_ENTITY" ]]; then
        # MCP servers (optional)
        FIRECRAWL_API_KEY=$(vault_secret "secret/users/${VAULT_ENTITY}/firecrawl")
        [[ -n "$FIRECRAWL_API_KEY" ]] && export FIRECRAWL_API_KEY

        EXA_API_KEY=$(vault_secret "secret/users/${VAULT_ENTITY}/exa")
        [[ -n "$EXA_API_KEY" ]] && export EXA_API_KEY

        NOTION_API_KEY=$(vault_secret "secret/users/${VAULT_ENTITY}/notion")
        [[ -n "$NOTION_API_KEY" ]] && export NOTION_API_KEY
    fi
fi
