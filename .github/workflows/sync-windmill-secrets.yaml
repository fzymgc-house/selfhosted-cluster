# -*- coding: utf-8; mode: yaml -*-
# SPDX-License-Identifier: MIT
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow

name: Sync Windmill Secrets

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Target workspace'
        required: true
        type: choice
        options:
          - staging
          - prod
      dry_run:
        description: 'Preview changes without applying'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      workspace:
        required: true
        type: string
      dry_run:
        required: false
        type: boolean
        default: false
    secrets:
      VAULT_APPROLE_ROLE_ID:
        required: true
      VAULT_APPROLE_SECRET_ID:
        required: true

env:
  VAULT_ADDR: https://vault.fzymgc.house

jobs:
  sync:
    runs-on: fzymgc-house-cluster-runners
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Authenticate to Vault
        uses: hashicorp/vault-action@v3.4.0
        with:
          url: ${{ env.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
          secretId: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
          # exportToken exports VAULT_TOKEN env var for vault CLI usage
          # exportEnv is for exporting secrets as env vars (not needed here)
          exportToken: true

      - name: Sync secrets to Windmill
        run: |
          chmod +x ./scripts/sync-vault-to-windmill-vars.sh
          ./scripts/sync-vault-to-windmill-vars.sh \
            --workspace ${{ inputs.workspace }} \
            ${{ inputs.dry_run && '--dry-run' || '' }}
