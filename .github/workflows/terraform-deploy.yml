# Triggers Windmill terraform deployment flows when tf/* modules change
name: Terraform Deploy

on:
  push:
    branches: [main]
    paths:
      - 'tf/vault/**'
      - 'tf/grafana/**'
      - 'tf/authentik/**'
      - 'tf/cloudflare/**'
      - 'tf/core-services/**'
  workflow_dispatch:
    inputs:
      module:
        description: 'Terraform module to deploy'
        required: true
        type: choice
        options:
          - tf/vault
          - tf/grafana
          - tf/authentik
          - tf/cloudflare
          - tf/core-services

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      vault: ${{ steps.filter.outputs.vault }}
      grafana: ${{ steps.filter.outputs.grafana }}
      authentik: ${{ steps.filter.outputs.authentik }}
      cloudflare: ${{ steps.filter.outputs.cloudflare }}
      core-services: ${{ steps.filter.outputs.core-services }}
    steps:
      - uses: actions/checkout@v6.0.1
      - uses: dorny/paths-filter@v3.0.2
        id: filter
        with:
          filters: |
            vault:
              - 'tf/vault/**'
            grafana:
              - 'tf/grafana/**'
            authentik:
              - 'tf/authentik/**'
            cloudflare:
              - 'tf/cloudflare/**'
            core-services:
              - 'tf/core-services/**'

  deploy:
    runs-on: fzymgc-house-cluster-runners
    needs: [detect-changes]
    if: always() && (needs.detect-changes.result == 'success' || needs.detect-changes.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        module: [tf/vault, tf/grafana, tf/authentik, tf/cloudflare, tf/core-services]
    steps:
      - name: Check if should deploy
        id: should-deploy
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.module }}" == "${{ matrix.module }}" ]; then
              echo "deploy=true" >> $GITHUB_OUTPUT
            else
              echo "deploy=false" >> $GITHUB_OUTPUT
            fi
          else
            case "${{ matrix.module }}" in
              tf/vault)
                echo "deploy=${{ needs.detect-changes.outputs.vault }}" >> $GITHUB_OUTPUT
                ;;
              tf/grafana)
                echo "deploy=${{ needs.detect-changes.outputs.grafana }}" >> $GITHUB_OUTPUT
                ;;
              tf/authentik)
                echo "deploy=${{ needs.detect-changes.outputs.authentik }}" >> $GITHUB_OUTPUT
                ;;
              tf/cloudflare)
                echo "deploy=${{ needs.detect-changes.outputs.cloudflare }}" >> $GITHUB_OUTPUT
                ;;
              tf/core-services)
                echo "deploy=${{ needs.detect-changes.outputs.core-services }}" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Trigger Windmill flow
        if: steps.should-deploy.outputs.deploy == 'true'
        timeout-minutes: 2
        env:
          WMILL_TOKEN: ${{ secrets.WMILL_TOKEN_PROD }}
        run: |
          echo "Triggering deploy for ${{ matrix.module }} at ${{ github.sha }}"

          # Try URL with /p/ prefix first (per async docs)
          WINDMILL_URL_1="https://windmill.fzymgc.house/api/w/terraform-gitops-prod/jobs/run/p/f/terraform/deploy_terraform"
          # Alternative URL without /p/ prefix (per sync docs format)
          WINDMILL_URL_2="https://windmill.fzymgc.house/api/w/terraform-gitops-prod/jobs/run/f/terraform/deploy_terraform"

          PAYLOAD="{\"module\": \"${{ matrix.module }}\", \"ref\": \"${{ github.sha }}\"}"

          echo "=== Trying URL format 1 (with /p/): $WINDMILL_URL_1 ==="
          http_code=$(curl -s -o /tmp/response1.json -w "%{http_code}" \
            --max-time 30 \
            --connect-timeout 10 \
            -X POST \
            -H "Authorization: Bearer $WMILL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$WINDMILL_URL_1")
          echo "HTTP Status: $http_code"
          echo "Response: $(cat /tmp/response1.json 2>/dev/null || echo '(empty)')"

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Success with URL format 1!"
            exit 0
          fi

          echo ""
          echo "=== Trying URL format 2 (without /p/): $WINDMILL_URL_2 ==="
          http_code=$(curl -s -o /tmp/response2.json -w "%{http_code}" \
            --max-time 30 \
            --connect-timeout 10 \
            -X POST \
            -H "Authorization: Bearer $WMILL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$WINDMILL_URL_2")
          echo "HTTP Status: $http_code"
          echo "Response: $(cat /tmp/response2.json 2>/dev/null || echo '(empty)')"

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Success with URL format 2!"
            exit 0
          fi

          echo ""
          echo "Both URL formats failed. Check Windmill configuration."
          exit 1
