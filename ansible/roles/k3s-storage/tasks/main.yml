# SPDX-License-Identifier: MIT-0
# code: language=ansible
---
# tasks file for k3s-storage

- name: Get UUID of btrfs volume
  ansible.builtin.command:
    cmd: blkid -s UUID -o value {{ k3s_storage_btrfs_root }}
  register: btrfs_uuid
  changed_when: false
  check_mode: false
  tags:
    - k3s-storage

- name: Check if btrfs subvolumes exist
  ansible.builtin.stat:
    path: /data/{{ item }}
  loop: "{{ k3s_storage_subvolumes }}"
  register: k3s_storage_subvol_stat
  tags:
    - k3s-storage

- name: Create btrfs subvolumes
  ansible.builtin.command:
    cmd: btrfs subvolume create /data/{{ item.item }}
  loop: "{{ k3s_storage_subvol_stat.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: not item.stat.exists
  changed_when: true
  tags:
    - k3s-storage

- name: Create mount point directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: "0755"
    owner: root
    group: root
  loop: "{{ k3s_storage_mounts }}"
  tags:
    - k3s-storage

- name: Create systemd mount units
  ansible.builtin.template:
    src: systemd-mount.j2
    dest: /etc/systemd/system/{{ item.name }}.mount
    mode: "0644"
    owner: root
    group: root
  vars:
    uuid: "{{ btrfs_uuid.stdout }}"
    mount_path: "{{ item.path }}"
    mount_name: "{{ item.name }}"
    btrfs_subvolume: "{{ k3s_storage_btrfs_subvol_prefix }}/data/{{ item.subvol }}"
  loop: "{{ k3s_storage_mounts }}"
  notify: Reload systemd
  tags:
    - k3s-storage

- name: Enable and start mount units
  ansible.builtin.systemd:
    name: "{{ item.name }}.mount"
    state: started
    enabled: true
    daemon_reload: true
  loop: "{{ k3s_storage_mounts }}"
  tags:
    - k3s-storage
