# code: language=ansible


- name: Install cert-manager helm chart
  kubernetes.core.helm:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    namespace: cert-manager
    name: cert-manager
    create_namespace: true
    chart_ref: cert-manager
    chart_repo_url: https://charts.jetstack.io/
    chart_version: v1.17.2
    wait: false
    values:
      crds:
        enabled: true
      replicaCount: 2
      dns01RecursiveNameservers: "https://1.1.1.1/dns-query"
      dns01RecursiveNameserversOnly: true
      config:
        apiVersion: controller.config.cert-manager.io/v1alpha1
        kind: ControllerConfiguration
        logging:
          verbosity: 2
          format: text
        enableGatewayAPI: true
        featureGates:
          ServerSideApply: true
          UseCertificateRequestBasicConstraints: true
          OtherNames: true
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false
  tags:
    - k8s-cert-manager-install

- name: Add cloudflare api token secret
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    definition:
      apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: cloudflare-api-token
        namespace: cert-manager
      spec:
        refreshInterval: 5m
        secretStoreRef:
          name: onepassword-sdk
          kind: ClusterSecretStore
        target:
          creationPolicy: Owner
          name: cloudflare-api-token
          type: Opaque
          template:
            engineVersion: v2
            data:
              api-token: "{{ '{{.api_token }}' }}"
        data:
          - secretKey: api_token
            remoteRef:
              key: cloudflare-api-token/password
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false

- name: Add cloudflare acme issuer
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    namespace: cert-manager
    src: "{{ role_path }}/files/cert-manager/cloudflare-acme-issuer.yaml"
  become: false
  run_once: true
  delegate_to: localhost

- name: Add fzymgc-house-ica1-ca cert and key
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    definition:
      apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: fzymgc-house-ica1-key
        namespace: cert-manager
      spec:
        refreshInterval: 5m
        secretStoreRef:
          name: onepassword-sdk
          kind: ClusterSecretStore
        target:
          creationPolicy: Owner
          name: fzymgc-house-ica1-key
          type: Opaque
          template:
            engineVersion: v2
            data:
              tls.crt: |
                "{{ '{{.tls_crt }}' }}"
              tls.key: |
                "{{ '{{.tls_key }}' }}"
        data:
          - secretKey: tls_crt
            remoteRef:
              key: fzymgc-ica1-ca/cert
          - secretKey: tls_key
            remoteRef:
              key: fzymgc-ica1-ca/cleartext_key
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false

- name: Add fzymgc-house-issuer
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    namespace: cert-manager
    src: "{{ role_path }}/files/cert-manager/fzymgc-house-issuer.yaml"
  become: false
  run_once: true
  delegate_to: localhost
