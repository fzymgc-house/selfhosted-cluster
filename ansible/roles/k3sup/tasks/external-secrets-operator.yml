# SPDX-License-Identifier: MIT-0
# code: language=ansible

- name: Install External Secrets Operator via Helm
  kubernetes.core.helm:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    namespace: external-secrets
    name: external-secrets-operator
    create_namespace: true
    chart_ref: external-secrets
    chart_repo_url: https://charts.external-secrets.io
    chart_version: 0.20.4
    wait: true
    values:
      installCRDs: true
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false

- name: Create Vault CA Chain Secret
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: vault-ca-chain
        namespace: external-secrets
      type: Opaque
      stringData:
        ca.crt: "{{ lookup('community.general.onepassword', 'fzymgc-ica1-ca', vault='fzymgc-house', field='fullchain') }}"
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false

- name: Configure Vault ClusterSecretStore for External Secrets
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    definition:
      apiVersion: external-secrets.io/v1
      kind: ClusterSecretStore
      metadata:
        name: vault
      spec:
        provider:
          vault:
            server: https://vault-internal.vault:8200
            path: secret
            version: v2
            auth:
              kubernetes:
                mountPath: kubernetes
                role: external-secrets
            caProvider:
              type: Secret
              name: vault-ca-chain
              key: ca.crt
              namespace: external-secrets
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false
