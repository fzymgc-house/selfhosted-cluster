# SPDX-License-Identifier: MIT-0
# code: language=ansible

- name: Install External Secrets Operator via Helm
  kubernetes.core.helm:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    namespace: external-secrets
    name: external-secrets-operator
    create_namespace: true
    chart_ref: external-secrets
    chart_repo_url: https://charts.external-secrets.io
    chart_version: 0.19.2
    wait: true
    values:
      installCRDs: true
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false

- name: Create 1passwordSDK ServiceAccount Secrets
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: onepassword-sdk-service-account
        namespace: external-secrets
      stringData:
        token: "{{ k3sup_onepassword_sdk_token }}"
  become: false
  run_once: true
  delegate_to: localhost

- name: Create 1passwordSDK ClusterSecretStore
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    definition:
      apiVersion: external-secrets.io/v1
      kind: ClusterSecretStore
      metadata:
        name: onepassword-sdk
      spec:
        provider:
          onepasswordSDK:
            vault: fzymgc-house
            auth:
              serviceAccountSecretRef:
                name: onepassword-sdk-service-account
                key: token
                namespace: external-secrets
            integrationInfo:
              name: integration-info
              version: v1
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false

- name: Create Vault CA Chain Secret
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    definition:
      apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: vault-ca-chain
        namespace: external-secrets
      spec:
        refreshInterval: 1h
        secretStoreRef:
          name: onepassword-sdk
          kind: ClusterSecretStore
        target:
          creationPolicy: Owner
          name: vault-ca-chain
          type: kubernetes.io/tls
          template:
            engineVersion: v2
            data:
              ca.crt: |
                "{{ '{{.ca_crt }}' }}"
        data:
          - secretKey: ca_crt
            remoteRef:
              key: fzymgc-ica1-ca/fullchain
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false

- name: Configure Vault ClusterSecretStore for External Secrets
  kubernetes.core.k8s:
    kubeconfig: "/Users/sean/.kube/configs/{{ k8s_context }}-admin.yml"
    state: present
    definition:
      apiVersion: external-secrets.io/v1
      kind: ClusterSecretStore
      metadata:
        name: vault
      spec:
        provider:
          vault:
            server: https://vault-internal.vault:8200
            path: secret
            version: v2
            auth:
              kubernetes:
                mountPath: kubernetes
                role: external-secrets
            caProvider:
              type: Secret
              name: vault-ca-chain
              key: ca.crt
              namespace: external-secrets
  become: false
  run_once: true
  delegate_to: localhost
  changed_when: false
