# SPDX-License-Identifier: MIT-0
# code: language=ansible
---
# defaults file for longhorn-disks
#
# This role configures additional block devices for Longhorn distributed storage.
#
# LIMITATIONS:
# - Check mode (--check) will not fully validate disk operations
# - Disk partitioning/formatting tasks always show as changed in check mode
# - Use --check --diff to preview mount unit changes only
#
# DISK REMOVAL (manual process by design):
# This role does NOT automatically remove disks from Longhorn when entries are
# removed from longhorn_additional_disks. This is intentional because automatic
# removal could cause data loss if replicas exist on the disk.
#
# To safely remove a disk from Longhorn:
# 1. In Longhorn UI: Set "Scheduling" to "Disable" for the disk
# 2. In Longhorn UI: Wait for all replicas to evacuate (disk shows 0 replicas)
# 3. Remove the disk entry from longhorn_additional_disks in host_vars
# 4. SSH to the node and stop/disable the mount unit:
#    systemctl disable --now <mount-base>-longhorn-<disk-name>.mount
# 5. (Optional) In Longhorn UI: Delete the disk entry from the node
# 6. (Optional) Wipe the disk: wipefs -a /dev/sdX

# Additional disks for Longhorn - set per host in host_vars
# Disk names must match: ^[a-zA-Z0-9][a-zA-Z0-9_-]*$
# longhorn_additional_disks:
#   - device: /dev/sda       # Block device (must exist)
#     name: sata-storage-1   # Unique identifier (alphanumeric, _, -)
#     tags:                  # Optional Longhorn scheduling tags
#       - sata
#       - bulk

# Base mount path for additional Longhorn disks
longhorn_disk_mount_base: /data

# BTRFS subvolume name inside each disk
longhorn_disk_subvol_name: longhorn

# Default Longhorn disk path (the pre-existing disk from Longhorn installation)
# This is included in fresh cluster annotations alongside additional disks
longhorn_default_disk_path: "{{ longhorn_disk_mount_base }}/longhorn"

# BTRFS mount options (compression can be disabled for performance-critical storage)
# Set to "defaults,noatime,compress=no" to disable compression
longhorn_disk_mount_options: "defaults,noatime,compress=zstd"

# Systemd mount timeout in seconds (for slow disk initialization)
longhorn_disk_mount_timeout: 300

# Timeout for partition to appear after creation (seconds)
longhorn_disk_partition_timeout: 60

# Kubeconfig path for Longhorn registration
longhorn_kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config') }}"
