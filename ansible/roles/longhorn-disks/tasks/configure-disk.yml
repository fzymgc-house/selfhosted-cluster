# SPDX-License-Identifier: MIT-0
# code: language=ansible
---
# Configure a single disk for Longhorn storage
# Called with loop_var: disk

- name: Check disk is empty (no partition table) - {{ disk.name }}
  ansible.builtin.command:
    cmd: blkid -p {{ disk.device }}
  register: disk_empty_check
  failed_when: false
  changed_when: false
  check_mode: false

- name: Fail if disk has existing data - {{ disk.name }}
  ansible.builtin.fail:
    msg: |
      SAFETY CHECK FAILED: {{ disk.device }} contains existing data!
      blkid output: {{ disk_empty_check.stdout }}
      To proceed, manually wipe the disk first: wipefs -a {{ disk.device }}
  when: disk_empty_check.rc == 0

- name: Create GPT partition table - {{ disk.name }}
  ansible.builtin.command:
    cmd: parted -s {{ disk.device }} mklabel gpt
  changed_when: true

- name: Create partition spanning entire disk - {{ disk.name }}
  ansible.builtin.command:
    cmd: parted -s {{ disk.device }} mkpart primary 0% 100%
  changed_when: true

- name: Wait for udev to settle - {{ disk.name }}
  ansible.builtin.command:
    cmd: udevadm settle --timeout=30
  changed_when: false

- name: Wait for partition to appear - {{ disk.name }}
  ansible.builtin.wait_for:
    path: "{{ disk.device }}1"
    state: present
    timeout: 60

- name: Format partition as BTRFS - {{ disk.name }}
  ansible.builtin.command:
    cmd: mkfs.btrfs -f -L longhorn-{{ disk.name }} {{ disk.device }}1
  changed_when: true

- name: Create secure temporary mount point - {{ disk.name }}
  ansible.builtin.tempfile:
    state: directory
    prefix: longhorn-disk-
  register: temp_mount_dir

- name: Mount partition temporarily - {{ disk.name }}
  ansible.posix.mount:
    path: "{{ temp_mount_dir.path }}"
    src: "{{ disk.device }}1"
    fstype: btrfs
    state: mounted

- name: Create BTRFS subvolume - {{ disk.name }}
  ansible.builtin.command:
    cmd: btrfs subvolume create {{ temp_mount_dir.path }}/{{ longhorn_disk_subvol_name }}
  changed_when: true

- name: Unmount temporary mount - {{ disk.name }}
  ansible.posix.mount:
    path: "{{ temp_mount_dir.path }}"
    state: unmounted

- name: Remove temporary mount point - {{ disk.name }}
  ansible.builtin.file:
    path: "{{ temp_mount_dir.path }}"
    state: absent
