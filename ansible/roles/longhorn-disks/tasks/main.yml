# SPDX-License-Identifier: MIT-0
# code: language=ansible
---
# tasks file for longhorn-disks
# Configures additional block devices for Longhorn storage

- name: Install disk management tools
  ansible.builtin.apt:
    name:
      - parted
      - btrfs-progs
      - util-linux
    state: present
    update_cache: true
    cache_valid_time: 3600
  when: longhorn_additional_disks is defined and longhorn_additional_disks | length > 0
  tags:
    - longhorn-disks

- name: Process additional Longhorn disks
  when: longhorn_additional_disks is defined and longhorn_additional_disks | length > 0
  tags:
    - longhorn-disks
  block:
    - name: Verify BTRFS kernel module is available
      ansible.builtin.command:
        cmd: modprobe -n btrfs
      changed_when: false
      check_mode: false

    - name: Validate disk names contain only safe characters
      ansible.builtin.assert:
        that:
          - item.name is regex('^[a-zA-Z0-9][a-zA-Z0-9_-]*$')
        fail_msg: |
          Invalid disk name: {{ item.name }}
          Disk names must start with alphanumeric and contain only: a-z A-Z 0-9 _ -
        quiet: true
      loop: "{{ longhorn_additional_disks }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Validate disk devices exist
      ansible.builtin.stat:
        path: "{{ item.device }}"
      register: disk_device_check
      loop: "{{ longhorn_additional_disks }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Fail if any disk device does not exist
      ansible.builtin.fail:
        msg: |
          Disk device not found: {{ item.item.device }}
          Ensure the device exists and is a valid block device.
      loop: "{{ disk_device_check.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: not item.stat.exists

    - name: Validate devices are block devices
      ansible.builtin.fail:
        msg: |
          {{ item.item.device }} is not a block device (isblk={{ item.stat.isblk | default(false) }})
          Only block devices can be used for Longhorn storage.
      loop: "{{ disk_device_check.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: item.stat.exists and not (item.stat.isblk | default(false))

    - name: Check existing mounts for each disk
      ansible.builtin.command:
        cmd: findmnt -n {{ longhorn_disk_mount_base }}/longhorn-{{ item.name }}
      loop: "{{ longhorn_additional_disks }}"
      loop_control:
        label: "{{ item.name }}"
      register: longhorn_disk_mount_check
      failed_when: false
      changed_when: false
      check_mode: false

    - name: Build list of disks needing setup
      ansible.builtin.set_fact:
        longhorn_disks_to_configure: >-
          {{
            longhorn_additional_disks | zip(longhorn_disk_mount_check.results)
            | selectattr('1.rc', 'ne', 0)
            | map(attribute='0')
            | list
          }}

    - name: Warn about check mode limitations for disk operations
      ansible.builtin.debug:
        msg: |
          CHECK MODE WARNING: {{ longhorn_disks_to_configure | length }} disk(s) need configuration.
          Disk partitioning and formatting cannot be validated in check mode.
          Run without --check to actually configure disks.
      when: ansible_check_mode and longhorn_disks_to_configure | length > 0

    - name: Configure each new disk
      ansible.builtin.include_tasks: configure-disk.yml
      loop: "{{ longhorn_disks_to_configure }}"
      loop_control:
        loop_var: disk
        label: "{{ disk.name }}"

    - name: Get disk info for mount units
      ansible.builtin.command:
        cmd: blkid -s UUID -o value "{{ item.device }}1"
      loop: "{{ longhorn_additional_disks }}"
      loop_control:
        label: "{{ item.name }}"
      register: longhorn_disk_uuids
      changed_when: false
      check_mode: false

    - name: Validate UUID retrieval succeeded
      ansible.builtin.assert:
        that:
          - item.stdout | length > 0
        fail_msg: |
          Failed to retrieve UUID for {{ item.item.device }}1
          Ensure the partition exists and has a valid filesystem.
        quiet: true
      loop: "{{ longhorn_disk_uuids.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Create mount point directories
      ansible.builtin.file:
        path: "{{ longhorn_disk_mount_base }}/longhorn-{{ item.name }}"
        state: directory
        mode: "0755"
        owner: root
        group: root
      loop: "{{ longhorn_additional_disks }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Create systemd mount units
      ansible.builtin.template:
        src: systemd-mount.j2
        dest: /etc/systemd/system/{{ longhorn_disk_mount_base | regex_replace('/', '-') | regex_replace('^-', '') }}-longhorn-{{ item.0.name }}.mount
        mode: "0644"
        owner: root
        group: root
      vars:
        disk_uuid: "{{ item.1.stdout }}"
        mount_path: "{{ longhorn_disk_mount_base }}/longhorn-{{ item.0.name }}"
        disk_name: "{{ item.0.name }}"
      loop: "{{ longhorn_additional_disks | zip(longhorn_disk_uuids.results) | list }}"
      loop_control:
        label: "{{ item.0.name }}"
      notify: Reload systemd

    - name: Enable and start mount units
      ansible.builtin.systemd:
        name: "{{ longhorn_disk_mount_base | regex_replace('/', '-') | regex_replace('^-', '') }}-longhorn-{{ item.name }}.mount"
        state: started
        enabled: true
        daemon_reload: true
      loop: "{{ longhorn_additional_disks }}"
      loop_control:
        label: "{{ item.name }}"
