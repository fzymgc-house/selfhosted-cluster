# SPDX-License-Identifier: MIT-0
# code: language=ansible
---
# Register additional disks with Longhorn
# This task runs delegated to localhost with kubectl access

- name: Build Longhorn disk configuration
  when: longhorn_additional_disks is defined and longhorn_additional_disks | length > 0
  tags:
    - longhorn-disks
    - longhorn-register
  block:
    - name: Build disk config for Longhorn
      ansible.builtin.set_fact:
        longhorn_disk_config_list: |
          {% set disks = [{"path": longhorn_default_disk_path, "allowScheduling": true}] %}
          {% for disk in longhorn_additional_disks %}
          {% set disk_entry = {"path": longhorn_disk_mount_base + "/longhorn-" + disk.name, "allowScheduling": true} %}
          {% if disk.tags is defined %}
          {% set disk_entry = disk_entry | combine({"tags": disk.tags}) %}
          {% endif %}
          {% set _ = disks.append(disk_entry) %}
          {% endfor %}
          {{ disks | to_json }}

    - name: Check if Longhorn is installed
      kubernetes.core.k8s_info:
        kubeconfig: "{{ longhorn_kubeconfig }}"
        kind: Deployment
        name: longhorn-driver-deployer
        namespace: longhorn-system
      register: longhorn_deployment_check
      delegate_to: localhost
      become: false
      retries: 3
      delay: 5
      until: longhorn_deployment_check is not failed

    - name: Set Longhorn installed fact
      ansible.builtin.set_fact:
        longhorn_is_installed: "{{ longhorn_deployment_check.resources | length > 0 }}"

    # For fresh clusters - set annotation before Longhorn is installed
    - name: Set node annotation for Longhorn disk discovery
      kubernetes.core.k8s:
        kubeconfig: "{{ longhorn_kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Node
          metadata:
            name: "{{ inventory_hostname }}"
            annotations:
              node.longhorn.io/default-disks-config: "{{ longhorn_disk_config_list | trim }}"
      delegate_to: localhost
      become: false
      when: not longhorn_is_installed

    # For existing clusters - fetch current config and merge with new disks
    - name: Get existing Longhorn Node configuration
      kubernetes.core.k8s_info:
        kubeconfig: "{{ longhorn_kubeconfig }}"
        api_version: longhorn.io/v1beta2
        kind: Node
        name: "{{ inventory_hostname }}"
        namespace: longhorn-system
      register: longhorn_node_info
      delegate_to: localhost
      become: false
      when: longhorn_is_installed
      retries: 3
      delay: 5
      until: longhorn_node_info is not failed

    - name: Extract existing disk configuration
      ansible.builtin.set_fact:
        longhorn_existing_disks: "{{ longhorn_node_info.resources[0].spec.disks | default({}) }}"
      when: longhorn_is_installed and longhorn_node_info.resources | length > 0

    - name: Set empty existing disks if node not found
      ansible.builtin.set_fact:
        longhorn_existing_disks: {}
      when: longhorn_is_installed and (longhorn_node_info.resources | length == 0)

    # Detect orphaned disks (in Longhorn but not in config)
    # These are disks that were previously configured but have been removed from host_vars
    - name: Detect orphaned disks in Longhorn
      ansible.builtin.set_fact:
        longhorn_orphaned_disks: |
          {% set configured_names = longhorn_additional_disks | map(attribute='name') | list %}
          {% set orphaned = [] %}
          {% for disk_name, disk_spec in longhorn_existing_disks.items() %}
          {% if disk_name != 'default' and disk_name not in configured_names %}
          {% set _ = orphaned.append({'name': disk_name, 'path': disk_spec.path | default('unknown')}) %}
          {% endif %}
          {% endfor %}
          {{ orphaned }}
      when: longhorn_is_installed and longhorn_existing_disks | length > 0

    - name: Warn about orphaned disks in Longhorn
      ansible.builtin.debug:
        msg: |
          WARNING: Found {{ longhorn_orphaned_disks | length }} disk(s) in Longhorn that are not in host_vars config:
          {% for disk in longhorn_orphaned_disks %}
            - {{ disk.name }} ({{ disk.path }})
          {% endfor %}
          These disks may have been removed from config but still exist in Longhorn.
          To remove them safely, follow the disk removal procedure in defaults/main.yml.
      when:
        - longhorn_is_installed
        - longhorn_orphaned_disks is defined
        - longhorn_orphaned_disks | length > 0

    # Patch Longhorn Node CRD - merge existing config with new disks
    # Preserves existing disk settings (storageReserved, tags, etc.) when disk already exists
    - name: Patch Longhorn Node with additional disks
      kubernetes.core.k8s:
        kubeconfig: "{{ longhorn_kubeconfig }}"
        state: patched
        kind: Node
        api_version: longhorn.io/v1beta2
        name: "{{ inventory_hostname }}"
        namespace: longhorn-system
        definition:
          spec:
            disks: "{{ longhorn_node_disks_spec }}"
      vars:
        longhorn_node_disks_spec: |
          {% set disks = longhorn_existing_disks | default({}) %}
          {% for disk in longhorn_additional_disks %}
          {% set new_disk_spec = {
            "path": longhorn_disk_mount_base + "/longhorn-" + disk.name,
            "allowScheduling": true,
            "evictionRequested": false,
            "storageReserved": 0
          } %}
          {% if disk.tags is defined %}
          {% set new_disk_spec = new_disk_spec | combine({"tags": disk.tags}) %}
          {% endif %}
          {% if disk.name in disks %}
          {# Preserve existing settings, only update path and tags from config #}
          {% set existing = disks[disk.name] %}
          {% set merged = existing | combine({"path": new_disk_spec.path}) %}
          {% if disk.tags is defined %}
          {% set merged = merged | combine({"tags": disk.tags}) %}
          {% endif %}
          {% set _ = disks.update({disk.name: merged}) %}
          {% else %}
          {% set _ = disks.update({disk.name: new_disk_spec}) %}
          {% endif %}
          {% endfor %}
          {{ disks }}
      delegate_to: localhost
      become: false
      when: longhorn_is_installed
      register: longhorn_patch_result
      retries: 3
      delay: 5
      until: longhorn_patch_result is not failed
