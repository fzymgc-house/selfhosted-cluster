[Unit]
Description=Mount {{ mount_path }} for Longhorn storage ({{ disk_name }})
# Ordering: After block devices are ready, before k3s starts
# Note: The blockdev@ target name below uses \x2d escaping for hyphens in the UUID.
# This escaping is only needed for the unit name (After= directive), not the UUID= directive.
# Standard UUIDs contain only [0-9a-f-] which are safe characters.
After=systemd-modules-load.service local-fs-pre.target blockdev@{{ disk_uuid | regex_replace('-', '\\\\x2d') }}.target
Before=local-fs.target k3s.service
Requires=systemd-modules-load.service
ConditionPathIsDirectory={{ mount_path }}

[Mount]
What=UUID={{ disk_uuid }}
Where={{ mount_path }}
Type=btrfs
Options=subvol=/{{ longhorn_disk_subvol_name }},{{ longhorn_disk_mount_options | default('defaults,noatime,compress=zstd') }}
TimeoutSec={{ longhorn_disk_mount_timeout | default(300) }}

[Install]
WantedBy=local-fs.target
# Ensure k3s waits for this mount before starting
RequiredBy=k3s.service
