# SPDX-License-Identifier: MIT-0
# code: language=ansible
---
# Fetch Vault AppRole credentials at deploy time
# Runs on localhost (where Vault token is available) and copies to target

- name: Read AppRole role_id from Vault
  community.hashi_vault.vault_read:
    url: "{{ router_hosts_vault_addr }}"
    ca_cert: "{{ router_hosts_vault_ca_cert }}"
    path: "auth/approle/role/{{ router_hosts_vault_approle_name }}/role-id"
  register: router_hosts_role_id_result
  delegate_to: localhost
  become: false
  no_log: true
  tags:
    - router-hosts
    - router-hosts-vault

- name: Generate new AppRole secret_id from Vault
  community.hashi_vault.vault_write:
    url: "{{ router_hosts_vault_addr }}"
    ca_cert: "{{ router_hosts_vault_ca_cert }}"
    path: "auth/approle/role/{{ router_hosts_vault_approle_name }}/secret-id"
  register: router_hosts_secret_id_result
  delegate_to: localhost
  become: false
  no_log: true
  tags:
    - router-hosts
    - router-hosts-vault

- name: Set AppRole facts
  ansible.builtin.set_fact:
    router_hosts_role_id: "{{ router_hosts_role_id_result.data.data.role_id }}"
    router_hosts_secret_id: "{{ router_hosts_secret_id_result.data.data.secret_id }}"
  no_log: true
  tags:
    - router-hosts
    - router-hosts-vault

- name: Verify credentials were retrieved
  ansible.builtin.assert:
    that:
      - router_hosts_role_id | length > 0
      - router_hosts_secret_id | length > 0
    fail_msg: "Failed to retrieve AppRole credentials from Vault"
    quiet: true
  no_log: true
  tags:
    - router-hosts
    - router-hosts-vault
