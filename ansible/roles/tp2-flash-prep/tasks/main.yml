# SPDX-License-Identifier: MIT-0
---
# tasks file for tp2-flash

- name: Check if image file is on Host # noqa: command-instead-of-shell
  ansible.builtin.shell:
    cmd: |
      ssh {{ inventory_hostname }} ls /mnt/sdcard/images/talos-{{ talos_version }}-{{ machine_kind }}.raw
  delegate_to: localhost
  register: image_file_check
  changed_when: false
  failed_when: false

# yamllint disable rule:line-length
- name: Copy image to Host
  ansible.builtin.shell:
    cmd: |
      scp {{ role_path }}/files/images/talos-{{ talos_version }}-{{ machine_kind }}-metal-{{ machine_arch }}.raw.xz {{ inventory_hostname }}:{{ destination_path }}.xz
      ssh {{ inventory_hostname }} xz -d {{ destination_path }}.xz
  delegate_to: localhost
  when: image_file_check.stdout != destination_path
  changed_when: false

