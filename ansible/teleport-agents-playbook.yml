---
# SPDX-License-Identifier: MIT
# code: language=ansible
# Deploy Teleport SSH agents to cluster nodes
#
# This playbook generates short-lived join tokens dynamically using tctl,
# eliminating the need for static tokens stored in Vault.

- name: Generate Teleport Join Token
  hosts: localhost
  gather_facts: false
  vars:
    teleport_namespace: teleport
    teleport_deployment: teleport-auth
    token_ttl: 15m

  tasks:
    - name: Wait for Teleport auth deployment to be ready
      ansible.builtin.command:
        cmd: >-
          kubectl --context fzymgc-house wait --for=condition=available
          deployment/{{ teleport_deployment }} -n {{ teleport_namespace }}
          --timeout=300s
      changed_when: false

    - name: Generate short-lived join token via tctl
      ansible.builtin.command:
        cmd: >-
          kubectl --context fzymgc-house exec -n {{ teleport_namespace }}
          deployment/{{ teleport_deployment }} --
          tctl tokens add --type=node --ttl={{ token_ttl }} --format=text
      register: token_result
      changed_when: false

    - name: Set join token fact for other plays
      ansible.builtin.set_fact:
        teleport_join_token: "{{ token_result.stdout | trim }}"
      delegate_to: localhost
      delegate_facts: true

    - name: Display token info
      ansible.builtin.debug:
        msg: "Generated short-lived join token (TTL: {{ token_ttl }}, length: {{ teleport_join_token | length }})"

- name: Deploy Teleport SSH Agents
  hosts: tp_cluster_nodes
  become: true
  gather_facts: true

  vars:
    # Use the token generated in the previous play
    teleport_join_token: "{{ hostvars['localhost']['teleport_join_token'] }}"

  pre_tasks:
    - name: Verify join token is available
      ansible.builtin.assert:
        that:
          - teleport_join_token is defined
          - teleport_join_token | length > 10
        fail_msg: "Join token not available or too short"
        success_msg: "Join token available (length: {{ teleport_join_token | length }})"

  roles:
    - teleport-agent

  post_tasks:
    - name: Verify Teleport service is running
      ansible.builtin.systemd:
        name: teleport
        state: started
      register: teleport_service

    - name: Display Teleport service status
      ansible.builtin.debug:
        msg: "Teleport service is {{ 'running' if teleport_service.status.ActiveState == 'active' else 'not running' }}"
