apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
    name: valkey
    namespace: argocd
    annotations:
        argocd.argoproj.io/sync-wave: "0"
spec:
    project: auth
    sources:
        - chart: valkey
          repoURL: registry-1.docker.io/bitnamicharts
          path: valkey
          targetRevision: 3.0.31
          helm:
              releaseName: valkey
              valuesObject:
                  architecture: replication
                  auth:
                      enabled: true
                      sentinel: true
                      existingSecret: valkey-password-secret
                      existingSecretPasswordKey: valkey-password
                  primary:
                      affinity:
                          podAffinity:
                              preferredDuringSchedulingIgnoredDuringExecution:
                                  - weight: 100
                                    podAffinityTerm:
                                        labelSelector:
                                            matchLabels:
                                                app.kubernetes.io/name: authentik
                                                app.kubernetes.io/instance: authentik
                                                app.kubernetes.io/component: server
                                        topologyKey: kubernetes.io/hostname
                      resourcesPreset: micro
                  replica:
                      replicaCount: 2
                      resourcesPreset: micro
        - repoURL: https://github.com/fzymgc-house/selfhosted-cluster
          targetRevision: HEAD
          path: argocd/app-configs/valkey
    destination:
        server: https://kubernetes.default.svc
        namespace: valkey
    syncPolicy:
        automated:
            prune: true
            selfHeal: true
        syncOptions:
            - ServerSideApply=true
            - CreateNamespace=true
            - RespectIgnoreDifferences=true
    ignoreDifferences:
        - kind: ExternalSecret
          group: external-secrets.io
          jqPathExpressions:
              - .spec.data[].remoteRef.conversionStrategy
              - .spec.data[].remoteRef.decodingStrategy
              - .spec.data[].remoteRef.metadataPolicy
