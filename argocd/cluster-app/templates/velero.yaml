apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: velero
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  sources:
    - chart: core-services
      repoURL: https://vmware-tanzu.github.io/helm-charts
      targetRevision: 10.1.0
      helm:
        releaseName: velero
        skipCrds: false
        valuesObject:
          image:
            repository: velero/velero
            tag: v1.16.2
          snapshotsEnabled: false
          deployNodeAgent: true
          configuration:
            features: EnableCSI
            backupStorageLocation:
              - name: default
                provider: velero.io/aws
                bucket: fzymgc-cluster-storage
                prefix: velero/backups
                default: true
                credential:
                  name: cloud-credentials
                  key: cloud
                config:
                  s3ForcePathStyle: "true"
                  s3Url: https://40753dbbbbd1540f02bd0707935ddb3f.r2.cloudflarestorage.com
                  publicUrl: https://40753dbbbbd1540f02bd0707935ddb3f.r2.cloudflarestorage.com
                  checksumAlgorithm: ""
          initContainers:
            - name: velero-plugin-for-aws
              image: velero/velero-plugin-for-aws:v1.12.2
              volumeMounts:
                - name: plugins
                  mountPath: /target
          defaultVolumesToFsBackup: false
          defaultRepoMaintainFrequency: "168h"
          metrics:
            enabled: true
            serviceMonitor:
              enabled: true
              interval: 30s
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          serviceAccount:
            create: false
            name: velero
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          nodeSelector:
            node-role.kubernetes.io/control-plane: "true"
    - repoURL: https://github.com/fzymgc-house/selfhosted-cluster
      targetRevision: HEAD
      path: argocd/app-configs/velero
  destination:
    server: https://kubernetes.default.svc
    namespace: velero
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - CreateNamespace=true
      - RespectIgnoreDifferences=true
  ignoreDifferences:
    - kind: ExternalSecret
      group: external-secrets.io
      jqPathExpressions:
        - .spec.data[].remoteRef.conversionStrategy
        - .spec.data[].remoteRef.decodingStrategy
        - .spec.data[].remoteRef.metadataPolicy