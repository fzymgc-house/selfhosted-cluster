apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: windmill
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  project: core-services
  sources:
    - chart: windmill
      repoURL: https://windmill-labs.github.io/windmill-helm-charts/
      targetRevision: "2.0.486"
      helm:
        releaseName: windmill
        valuesObject:
          windmill:
            appReplicas: 2
            workerReplicas: 3
            lspReplicas: 1
            multiplayer: 1
            baseUrl: "https://windmill.fzymgc.house"
            cookieDomain: "fzymgc.house"
            databaseUrlSecretName: windmill-secrets
            databaseUrlSecretKey: database_url
            exposeHostDocker: true
            rustLog: "info"
          postgresql:
            enabled: false
          redis:
            enabled: false
          minio:
            enabled: false
          workerGroups:
            # workers configuration
            # The default worker group
            - name: "default"
              # -- Controller to use. Valid options are "Deployment" and "StatefulSet"
              controller: "Deployment"

              replicas: 3
              # -- Annotations to apply to the pods
              annotations: {}

              # -- If a job is being ran, the container will wait for it to finish before terminating until this grace period
              terminationGracePeriodSeconds: 604800

              # -- Labels to apply to the pods
              labels: {}

              # -- Node selector to use for scheduling the pods
              nodeSelector: {}

              # -- Tolerations to apply to the pods
              tolerations: []

              # -- Host aliases to apply to the pods (overrides global hostAliases if set)
              hostAliases: []

              # -- Security context to apply to the container
              podSecurityContext:
                # -- run as user. The default is 0 for root user
                runAsUser: 0
                # -- run explicitly as a non-root user. The default is false.
                runAsNonRoot: false
              # -- Security context to apply to the pod
              containerSecurityContext: {}

              # -- Affinity rules to apply to the pods
              affinity: {}

              # -- Resource limits and requests for the pods
              resources:
                limits:
                  memory: "2Gi"

              # -- Extra environment variables to apply to the pods
              extraEnv:
                - name: INIT_SCRIPT
                  value: |
                    wget -O - https://apt.releases.hashicorp.com/gpg | \
                      sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg \
                      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list \
                      sudo apt update && sudo apt install -y vault
              # -- Extra sidecar containers
              extraContainers: []
              mode: "worker"

              # -- Init containers
              initContainers: []
              volumes: []
              volumeMounts: []

              # -- Volume claim templates. Only applies when controller is "StatefulSet"
              volumeClaimTemplates: []

              # -- command override
              command: []

              # -- mount the docker socket inside the container to be able to run docker command as docker client to the host docker daemon
              exposeHostDocker: false

            - name: "native"
              # -- Controller to use. Valid options are "Deployment" and "StatefulSet"
              controller: "Deployment"

              replicas: 1
              # -- Annotations to apply to the pods
              annotations: {}

              # -- Labels to apply to the pods
              labels: {}

              # -- Node selector to use for scheduling the pods
              nodeSelector: {}

              # -- Tolerations to apply to the pods
              tolerations: []

              # -- Host aliases to apply to the pods (overrides global hostAliases if set)
              hostAliases: []

              # -- Security context to apply to the container
              podSecurityContext:
                # -- run as user. The default is 0 for root user
                runAsUser: 0
                # -- run explicitly as a non-root user. The default is false.
                runAsNonRoot: false
              # -- Security context to apply to the pod
              containerSecurityContext: {}

              # -- Affinity rules to apply to the pods
              affinity: {}

              # -- Resource limits and requests for the pods
              resources:
                limits:
                  memory: "2Gi"

              # -- Extra environment variables to apply to the pods
              extraEnv:
                - name: "NUM_WORKERS"
                  value: "8"
                - name: "SLEEP_QUEUE"
                  value: "200"
              # -- Extra sidecar containers
              extraContainers: []

              mode: "worker"

              volumes: []
              volumeMounts: []

              # -- mount the docker socket inside the container to be able to run docker command as docker client to the host docker daemon
              exposeHostDocker: false

              # -- Volume claim templates. Only applies when controller is "StatefulSet"
              volumeClaimTemplates: []

            - name: "gpu"
              # -- Controller to use. Valid options are "Deployment" and "StatefulSet"
              controller: "Deployment"

              replicas: 0
              # -- Annotations to apply to the pods
              annotations: {}

              # -- Labels to apply to the pods
              labels: {}

              # -- Node selector to use for scheduling the pods
              nodeSelector: {}

              # -- Tolerations to apply to the pods
              tolerations: []

              # -- Host aliases to apply to the pods (overrides global hostAliases if set)
              hostAliases: []

              # -- Security context to apply to the container
              podSecurityContext:
                # -- run as user. The default is 0 for root user
                runAsUser: 0
                # -- run explicitly as a non-root user. The default is false.
                runAsNonRoot: false
              # -- Security context to apply to the pod
              containerSecurityContext: {}

              # -- Affinity rules to apply to the pods
              affinity: {}

              # -- Resource limits and requests for the pods
              resources:
                limits:
                  memory: "2Gi"

              # -- Extra environment variables to apply to the pods
              extraEnv: []
              # -- Extra sidecar containers
              extraContainers: []

              mode: "worker"

              volumes: []
              volumeMounts: []

              # -- command override
              command: []

              # -- mount the docker socket inside the container to be able to run docker command as docker client to the host docker daemon
              exposeHostDocker: false

              # -- Volume claim templates. Only applies when controller is "StatefulSet"
              volumeClaimTemplates: []

          app:
            annotations:
              reloader.stakater.com/auto: "true"
            # Resource estimates - not based on official recommendations
            # Chart defaults: ~128Mi memory, 100m CPU
            # These are conservative estimates for frontend workload
            resources:
              requests:
                memory: "500Mi"  # Estimate: 4x chart default for UI responsiveness
                cpu: "200m"      # Estimate: 2x chart default for multiple users
              limits:
                memory: "2Gi"    # Estimate: headroom for memory spikes
                cpu: "1000m"     # Estimate: burst capacity for UI operations
          workers:
            annotations:
              reloader.stakater.com/auto: "true"
            # Resource estimates - workers handle job execution
            # Chart defaults: ~256Mi memory, 200m CPU  
            # These are estimates based on assumption workers need more resources
            resources:
              requests:
                memory: "1Gi"    # Estimate: 4x chart default for job processing
                cpu: "500m"      # Estimate: 2.5x chart default for compute tasks
              limits:
                memory: "4Gi"    # Estimate: headroom for large job processing
                cpu: "2000m"     # Estimate: burst capacity for CPU-intensive jobs
          lsp:
            annotations:
              reloader.stakater.com/auto: "true"
            # Resource estimates - Language Server Protocol for code completion
            # Chart defaults: ~128Mi memory, 100m CPU
            # These are conservative estimates for LSP functionality
            resources:
              requests:
                memory: "200Mi"  # Estimate: 1.5x chart default for language parsing
                cpu: "100m"      # Estimate: same as chart default
              limits:
                memory: "1Gi"    # Estimate: headroom for large codebases
                cpu: "500m"      # Estimate: burst capacity for intensive parsing
          ingress:
            enabled: false
    - repoURL: https://github.com/fzymgc-house/selfhosted-cluster
      targetRevision: HEAD
      path: argocd/app-configs/windmill
  destination:
    server: https://kubernetes.default.svc
    namespace: windmill
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - CreateNamespace=true
      - RespectIgnoreDifferences=true
  ignoreDifferences:
    - kind: ExternalSecret
      group: external-secrets.io
      jqPathExpressions:
        - .spec.data[].remoteRef.conversionStrategy
        - .spec.data[].remoteRef.decodingStrategy
        - .spec.data[].remoteRef.metadataPolicy
