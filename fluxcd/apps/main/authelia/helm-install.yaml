apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authelia
  namespace: authelia
spec:
  interval: 5m
  chart:
    spec:
      chart: authelia
      version: "0.10.*"
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    rbac:
      enabled: true
    pod:
      kind: Deployment
      replicas: 2
      selectors:
        nodeSelector:
          node-role.kubernetes.io/control-plane: "true"
    ingress:
      enabled: false
      traefikCRD:
        enabled: false
    configMap:
      access_control:
        default_policy: two_factor
        rules:
          - domain: auth.fzymgc.house
            policy: bypass
          - domain: "whoami.tpi-beta.fzymgc.house"
            policy: bypass
            networks:
              - 192.168.20.0/22
              - 192.168.40.0/22
          - domain: "*.fzymgc.house"
            policy: one_factor
            networks:
              - 192.168.20.0/22
              - 192.168.40.0/22
      authentication_backend:
        password_reset:
          enabled: true
        refresh_interval: 1m
        file:
          enabled: false
        ldap:
          enabled: true
          implementation: lldap
          address: ldap://lldap.lldap.svc:389
          base_dn: dc=fzymgc,dc=house
          additional_users_dn: ou=people
          additional_groups_dn: ou=groups
          user: uid=authelia,ou=people,dc=fzymgc,dc=house
          users_filter: '(&({username_attribute}={input})(objectClass=person))'
          groups_filter: '(member={dn})'
          attributes:
            distinguished_name: distinguishedName
            username: uid
            mail: mail
            member_of: memberOf
            group_name: cn
      notifier:
        filesystem:
          enabled: false
        smtp:
          enabled: true
          address: "submissions://smtp.mailgun.org:465"
          username: "authelia@fzymgc.house"
          sender: "Authelia <authelia@fzymgc.house>"
          identifier: "fzymgc.house"
      ntp:
        address: udp://192.168.20.1:123
      session:
        cookies:
          - subdomain: auth
            domain: fzymgc.house
        redis:
          enabled: true
          deploy: false
          host: valkey-primary.valkey.svc.cluster.local
          port: 6379
      storage:
        postgres:
          enabled: true
          deploy: false
          address: tcp://main-rw.postgres.svc.cluster.local:5432
          database: authelia
          username: authelia
          tls:
            enabled: true
      theme: dark
    secret:
      existingSecret: authelia-secrets
    certificates:
      values:
        - name: fzymgc-root.pem
          value: |
            -----BEGIN CERTIFICATE-----
            MIIB/TCCAV6gAwIBAgIQcyZRKfTkjT13kJxk5XcboDAKBggqhkjOPQQDBDAZMRcw
            FQYDVQQDEw5menltZ2MgUm9vdCBDQTAeFw0yMzAxMDcxNzI0MzBaFw0zMzAxMDQx
            NzI0MzBaMBkxFzAVBgNVBAMTDmZ6eW1nYyBSb290IENBMIGbMBAGByqGSM49AgEG
            BSuBBAAjA4GGAAQAkiwKILt2XSBrlfFfmiZv+5xDkY0YTfllfNZJUUCUQ4ESpmS5
            5XFx2kUB0GUg+03W7cX6F5FzxLJF41h7neq9bxMBqVCjlXcRVghhvc8buH1X7UjO
            i0+5qq7kYkbhyYSju9gNcvMm2wxcRrHY0U8pU+tqu/dvkUJaocKQuI+fJAq3NZKj
            RTBDMA4GA1UdDwEB/wQEAwIBBjASBgNVHRMBAf8ECDAGAQH/AgEDMB0GA1UdDgQW
            BBTx8oH+7CHgzvULq/7eZlQf5ntxwDAKBggqhkjOPQQDBAOBjAAwgYgCQgEP7dfF
            tH3x0QceNXxVqheWv4Rx2NuMcO1WkvNlrCApQkh4AfEVlXPWglPLa7p5Xel+DdV3
            grEcXz25GxiLRCwuaAJCAXmmpARq1/0P+hXaMJSVlbGmOvMzUNw62clqnJiqcDjy
            v7iGEqychr9H5ypkQigcnvIGyGimfXn/lZRiqysBTOPK
            -----END CERTIFICATE-----
