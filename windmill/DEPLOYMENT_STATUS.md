# Windmill Staging/Production Deployment Status

**Last Updated**: 2025-12-07
**Status**: Partially Complete - Self-Hosted Runner Required

## What's Working ✅

### Infrastructure
- ✅ Two workspaces created: `terraform-gitops-staging` and `terraform-gitops-prod`
- ✅ All scripts, resources, and flows deployed to both workspaces
- ✅ `deploy_vault` flow fixed (approval module uses `identity` with `suspend`)
- ✅ GitHub secrets configured (`WMILL_TOKEN_PROD`)
- ✅ GitHub labels created (`windmill`, `autogenerated`)

### Git Integration (Partial)
- ✅ Branch structure: `windmill-staging` → `main`
- ✅ wmill.yaml configured correctly for each branch:
  - `windmill-staging` → `terraform-gitops-staging` workspace
  - `main` → `terraform-gitops-prod` workspace
- ⚠️ Git sync configured in UI but missing GitHub App credentials (see Issues below)

### GitHub Actions Workflows
- ✅ `.github/workflows/windmill-open-pr.yaml` - Auto-creates PRs from staging
- ✅ `.github/workflows/windmill-deploy-prod.yaml` - Deploys to production on merge
- ❌ **Workflows cannot run** - Windmill instance not accessible from GitHub's runners

## What's Broken ❌

### 1. Git Sync Resources Missing
**Issue**: Git repository resources were deleted during deployment

**Affected Resources**:
- `f/resources/git_selfhosted_repo_staging` (for sync mode)
- `f/resources/git_selfhosted_repo_main` (for promotion mode)

**Fix Applied**:
- Created resource and variable files with empty values
- Deployed to staging workspace

**Manual Step Required**:
In Windmill UI (terraform-gitops-staging workspace):
1. Go to Workspace Settings → Git Sync
2. Click "Test connection" on each sync mode
3. Re-authenticate with GitHub to populate OAuth credentials
4. This will update the variables with GitHub App installation IDs

### 2. GitHub Actions Deployment Fails
**Issue**: GitHub Actions runners cannot reach `windmill.fzymgc.house`

**Error**:
```
Error: getaddrinfo ENOTFOUND windmill.fzymgc.house
```

**Root Cause**: Windmill instance is only accessible on internal network

**Solution Required**: Deploy self-hosted GitHub Actions runner (see #129)

## Current Workflow Status

### What Works
**Manual Deployment** (Current Workaround):
```bash
# When PR merges to main:
git checkout main && git pull
cd windmill
wmill workspace switch terraform-gitops-prod
wmill sync push --yes
```

### What Doesn't Work
**Automated Deployment**:
- ❌ GitHub Actions can't reach Windmill
- ❌ PR merges don't auto-deploy to production
- ⚠️ Git sync in UI needs credentials reconfigured

## Architecture

### Two-Workspace Pattern

```
┌─────────────────────────────────────────────────────────────┐
│                    Staging Workspace                        │
│            (terraform-gitops-staging)                       │
│                                                             │
│  • Git Sync: Auto-commits to windmill-staging              │
│  • Promotion Mode: Creates branches targeting main         │
│  • Full access for development                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Git Sync (auto-commit)
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              windmill-staging Branch                         │
│                                                             │
│  • wmill.yaml → terraform-gitops-staging                    │
│  • All workspace resources/scripts/flows                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ GitHub Actions (blocked)
                            ↓
┌─────────────────────────────────────────────────────────────┐
│           PR: windmill-staging → main                        │
│                                                             │
│  • Auto-created by .github/workflows/windmill-open-pr.yaml │
│  • Labels: windmill, autogenerated                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ After PR merge
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    main Branch                               │
│                                                             │
│  • wmill.yaml → terraform-gitops-prod                       │
│  • Source of truth for production                           │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ GitHub Actions (blocked)
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                Production Workspace                          │
│             (terraform-gitops-prod)                         │
│                                                             │
│  • No Git sync - deployed via automation                    │
│  • Read-only access via UI                                  │
│  • Changes only via PR workflow                             │
└─────────────────────────────────────────────────────────────┘
```

## Next Steps

### Immediate Actions Required

1. **Fix Git Sync in Staging Workspace** (5 minutes)
   - Go to https://windmill.fzymgc.house
   - Switch to `terraform-gitops-staging` workspace
   - Navigate to Workspace Settings → Git Sync
   - Click "Test connection" on both sync modes
   - Re-authenticate with GitHub App

2. **Deploy Self-Hosted GitHub Runner** (Issue #129)
   - Runner configuration already exists in `argocd/app-configs/actions-runner-controller/`
   - Needs GitHub token created and stored in Vault
   - Once deployed, GitHub Actions workflows will work

### Optional Improvements

1. **Update README.md**
   - Document two-workspace architecture
   - Add GitOps workflow documentation
   - Update variable management for staging/prod split

2. **Create Manual Deployment Script**
   - `scripts/deploy-windmill-prod.sh`
   - Simplifies manual deployment until runner is ready

3. **Update Issue Tracking**
   - Close #137 (workflow created, just needs runner)
   - Update #129 with deployment instructions

## Related Issues

- **#129**: Deploy GitHub Actions Runner Controller (CRITICAL - blocks automation)
- **#137**: Create GitHub Actions workflow for wmill sync (COMPLETED - needs runner)

## Testing the Workflow (After Runner Deployment)

1. Make a change in staging workspace UI
2. Deploy the change
3. Verify auto-commit to `windmill-staging` branch
4. Verify PR auto-created from `windmill-staging` → `main`
5. Review and merge PR
6. Verify auto-deployment to production workspace

## Files Modified

### Workflows
- `.github/workflows/windmill-open-pr.yaml`
- `.github/workflows/windmill-deploy-prod.yaml`

### Configuration
- `windmill/wmill.yaml` (different per branch)
- `windmill/f/resources/git_selfhosted_repo_*.yaml` (newly created)

### Documentation
- This file (DEPLOYMENT_STATUS.md)
- README.md (needs update)

## Lessons Learned

1. **Git Sync Resources**: Windmill auto-creates Git sync resources during setup, but they need to be preserved in Git or they get deleted during sync operations

2. **Branch Protection**: Main branch protection works as expected - prevents direct pushes, forces PR workflow

3. **Approval Module Syntax**: Windmill EE v1.589.1 doesn't support `type: approval` - use `type: identity` with `suspend` property instead

4. **Self-Hosted Runner Requirement**: Internal-only services require self-hosted runners for GitHub Actions automation

5. **Workspace Configuration**: wmill.yaml must point to the correct workspace for each branch (staging vs prod)
