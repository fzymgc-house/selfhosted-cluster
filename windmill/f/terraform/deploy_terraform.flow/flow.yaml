summary: Deploy Terraform module with approval
description: |
  Generic deployment flow for any Terraform module:
  1. Clone repository at specified ref
  2. Initialize Terraform for specified module
  3. Run plan and check for changes
  4. If changes: send Discord notification, wait for approval, apply
  5. If no changes: complete silently

  Inputs:
  - module: Terraform module path (e.g., tf/vault)
  - ref: Git ref to checkout (commit SHA or branch)
schema:
  $schema: 'https://json-schema.org/draft/2020-12/schema'
  type: object
  required:
    - module
    - ref
  properties:
    module:
      type: string
      description: Terraform module path (e.g., tf/vault, tf/grafana, tf/authentik)
    ref:
      type: string
      description: Git ref to checkout (commit SHA or branch name)
value:
  same_worker: true
  # Concurrency control: only one flow per module at a time
  concurrent_limit: 1
  concurrency_key: 'tf-deploy-${flow_input.module}'
  modules:
    - id: git_clone
      value:
        type: script
        input_transforms:
          branch:
            type: javascript
            expr: flow_input.ref
          github:
            type: javascript
            expr: resource('f/resources/github')
          repository:
            type: static
            value: fzymgc-house/selfhosted-cluster
          workspace_dir:
            type: static
            value: /tmp/terraform-workspace
        path: f/terraform/git_clone
    - id: terraform_init
      value:
        type: script
        input_transforms:
          module_path:
            type: javascript
            expr: flow_input.module
          s3:
            type: javascript
            expr: resource('f/resources/s3')
          s3_bucket_prefix:
            type: javascript
            expr: variable('g/all/s3_bucket_prefix')
          tfc_token:
            type: javascript
            expr: variable('g/all/tfc_token')
          workspace_path:
            type: javascript
            expr: results.git_clone.workspace_path
        path: f/terraform/terraform_init
    - id: terraform_plan
      value:
        type: script
        input_transforms:
          module_dir:
            type: javascript
            expr: results.terraform_init.module_dir
          tfc_token:
            type: javascript
            expr: variable('g/all/tfc_token')
          vault_addr:
            type: static
            value: 'https://vault.fzymgc.house'
          vault_token:
            type: javascript
            expr: variable('g/all/vault_terraform_token')
          s3_resource:
            type: javascript
            expr: resource('f/resources/s3')
          job_id:
            type: javascript
            expr: Date.now().toString(36) + Math.random().toString(36).substring(2)
        path: f/terraform/terraform_plan
    - id: check_changes
      value:
        type: branchone
        branches:
          - summary: Has changes - request approval and apply
            expr: results.terraform_plan.has_changes
            modules:
              - id: notify_approval
                value:
                  type: script
                  input_transforms:
                    discord:
                      type: javascript
                      expr: resource('f/bots/terraform_discord_bot_configuration')
                    discord_bot_token:
                      type: javascript
                      expr: resource('f/bots/terraform_discord_bot_token_configuration')
                    module:
                      type: javascript
                      expr: flow_input.module
                    plan_details:
                      type: javascript
                      expr: results.terraform_plan.plan_details
                    plan_summary:
                      type: javascript
                      expr: results.terraform_plan.plan_summary
                  path: f/terraform/notify_approval
                suspend:
                  required_events: 1
                  timeout: 86400
              - id: terraform_apply
                value:
                  type: script
                  input_transforms:
                    module_dir:
                      type: javascript
                      expr: results.terraform_init.module_dir
                    tfc_token:
                      type: javascript
                      expr: variable('g/all/tfc_token')
                    vault_addr:
                      type: static
                      value: 'https://vault.fzymgc.house'
                    vault_token:
                      type: javascript
                      expr: variable('g/all/vault_terraform_token')
                    s3_resource:
                      type: javascript
                      expr: resource('f/resources/s3')
                    plan_s3_key:
                      type: javascript
                      expr: results.terraform_plan.plan_s3_key
                  path: f/terraform/terraform_apply
              - id: notify_success
                value:
                  type: script
                  input_transforms:
                    approval_message_id:
                      type: javascript
                      expr: results.notify_approval?.message_id
                    details:
                      type: static
                      value: Terraform apply completed successfully
                    discord:
                      type: javascript
                      expr: resource('f/bots/terraform_discord_bot_configuration')
                    discord_bot_token:
                      type: javascript
                      expr: resource('f/bots/terraform_discord_bot_token_configuration')
                    module:
                      type: javascript
                      expr: flow_input.module
                    status:
                      type: static
                      value: success
                  path: f/terraform/notify_status
        default: []
  failure_module:
    id: notify_failure
    value:
      type: script
      input_transforms:
        approval_message_id:
          type: javascript
          expr: results.notify_approval?.message_id
        details:
          type: javascript
          expr: error.message
        discord:
          type: javascript
          expr: resource('f/bots/terraform_discord_bot_configuration')
        discord_bot_token:
          type: javascript
          expr: resource('f/bots/terraform_discord_bot_token_configuration')
        module:
          type: javascript
          expr: flow_input.module
        status:
          type: static
          value: failed
      path: f/terraform/notify_status
