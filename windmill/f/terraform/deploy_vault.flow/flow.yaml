summary: Deploy Vault Terraform module with approval
description: |
  Automated deployment flow for tf/vault module:
  1. Clone repository
  2. Initialize Terraform
  3. Run plan and send to Discord for approval
  4. Wait for manual approval
  5. Apply changes
  6. Send completion notification
value:
  modules:
    - id: git_clone
      value:
        type: script
        input_transforms:
          branch:
            type: static
            value: main
          github:
            type: javascript
            expr: resource('f/resources/github')
          repository:
            type: static
            value: fzymgc-house/selfhosted-cluster
          workspace_dir:
            type: static
            value: /tmp/terraform-workspace
        path: f/terraform/git_clone
    - id: terraform_init
      value:
        type: script
        input_transforms:
          module_path:
            type: static
            value: tf/vault
          s3:
            type: javascript
            expr: resource('f/resources/s3')
          s3_bucket_prefix:
            type: javascript
            expr: variable('g/all/s3_bucket_prefix')
          workspace_path:
            type: javascript
            expr: results.git_clone.workspace_path
        path: f/terraform/terraform_init
    - id: terraform_plan
      value:
        type: script
        input_transforms:
          module_dir:
            type: javascript
            expr: results.terraform_init.module_dir
          vault_addr:
            type: static
            value: 'https://vault.fzymgc.house'
          vault_token:
            type: javascript
            expr: variable('g/all/vault_terraform_token')
        path: f/terraform/terraform_plan
    - id: notify_approval
      value:
        type: script
        input_transforms:
          discord:
            type: javascript
            expr: resource('f/bots/terraform_discord_bot_configuration')
          discord_bot_token:
            type: javascript
            expr: resource('f/bots/terraform_discord_bot_token_configuration')
          module:
            type: static
            value: tf/vault
          plan_details:
            type: javascript
            expr: results.terraform_plan.plan_details
          plan_summary:
            type: javascript
            expr: results.terraform_plan.plan_summary
          run_id:
            type: javascript
            expr: flow.id
        path: f/terraform/notify_approval
        skip_if:
          expr: results.terraform_plan.has_changes == false
          label: Skip if no changes
    - id: approval
      value:
        type: identity
        suspend:
          required_events: 1
          timeout: 86400
        skip_if:
          expr: results.terraform_plan.has_changes == false
          label: Skip if no changes
    - id: terraform_apply
      value:
        type: script
        input_transforms:
          module_dir:
            type: javascript
            expr: results.terraform_init.module_dir
          vault_addr:
            type: static
            value: 'https://vault.fzymgc.house'
          vault_token:
            type: javascript
            expr: variable('g/all/vault_terraform_token')
        path: f/terraform/terraform_apply
        skip_if:
          expr: results.terraform_plan.has_changes == false
          label: Skip if no changes
    - id: notify_success
      value:
        type: script
        input_transforms:
          approval_message_id:
            type: javascript
            expr: results.notify_approval?.message_id
          details:
            type: static
            value: Terraform apply completed successfully
          discord:
            type: javascript
            expr: resource('f/bots/terraform_discord_bot_configuration')
          discord_bot_token:
            type: javascript
            expr: resource('f/bots/terraform_discord_bot_token_configuration')
          module:
            type: static
            value: tf/vault
          status:
            type: static
            value: success
        path: f/terraform/notify_status
        skip_if:
          expr: results.terraform_plan.has_changes == false
          label: Skip if no changes
  failure_module:
    id: notify_failure
    value:
      type: script
      input_transforms:
        approval_message_id:
          type: javascript
          expr: results.notify_approval?.message_id
        details:
          type: javascript
          expr: error.message
        discord:
          type: javascript
          expr: resource('f/bots/terraform_discord_bot_configuration')
        discord_bot_token:
          type: javascript
          expr: resource('f/bots/terraform_discord_bot_token_configuration')
        module:
          type: static
          value: tf/vault
        status:
          type: static
          value: failed
      path: f/terraform/notify_status
schema: null
