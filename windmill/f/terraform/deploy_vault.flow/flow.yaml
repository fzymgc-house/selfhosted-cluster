summary: Deploy Vault Terraform module with approval
description: |
  Automated deployment flow for tf/vault module:
  1. Clone repository
  2. Initialize Terraform
  3. Run plan and send to Discord for approval
  4. Wait for manual approval
  5. Apply changes
  6. Send completion notification
value:
  modules:
    - id: git-clone
      value:
        type: script
        input_transforms:
          branch:
            type: static
            value: main
          github:
            type: javascript
            expr: wmill.getResource('f/resources/github')
          repository:
            type: static
            value: fzymgc-house/selfhosted-cluster
          workspace_dir:
            type: static
            value: /tmp/terraform-workspace
        path: f/terraform/git_clone
    - id: terraform-init
      value:
        type: script
        input_transforms:
          module_path:
            type: static
            value: tf/vault
          s3:
            type: javascript
            expr: wmill.getResource('f/resources/s3')
          s3_bucket_prefix:
            type: javascript
            expr: wmill.getVariable('s3_bucket_prefix')
          workspace_path:
            type: javascript
            expr: 'results[''git-clone''].workspace_path'
        path: f/terraform/terraform_init
    - id: terraform-plan
      value:
        type: script
        input_transforms:
          module_dir:
            type: javascript
            expr: 'results[''terraform-init''].module_dir'
          vault_addr:
            type: static
            value: 'https://vault.fzymgc.house'
          vault_token:
            type: javascript
            expr: wmill.getVariable('vault_terraform_token')
        path: f/terraform/terraform_plan
    - id: notify-approval
      value:
        type: script
        input_transforms:
          discord:
            type: javascript
            expr: wmill.getResource('f/bots/terraform_discord_bot_configuration')
          discord_bot_token:
            type: javascript
            expr: >-
              wmill.getResource('f/bots/terraform_discord_bot_token_configuration')
          module:
            type: static
            value: tf/vault
          plan_details:
            type: javascript
            expr: 'results[''terraform-plan''].plan_details'
          plan_summary:
            type: javascript
            expr: 'results[''terraform-plan''].plan_summary'
          run_id:
            type: javascript
            expr: flow.id
        path: f/terraform/notify_approval
        skip_if:
          expr: 'results[''terraform-plan''].has_changes == false'
          label: Skip if no changes
    - id: approval
      value:
        type: identity
        skip_if:
          expr: 'results[''terraform-plan''].has_changes == false'
          label: Skip if no changes
        suspend:
          required_events: 1
          timeout: 86400
    - id: terraform-apply
      value:
        type: script
        input_transforms:
          module_dir:
            type: javascript
            expr: 'results[''terraform-init''].module_dir'
          vault_addr:
            type: static
            value: 'https://vault.fzymgc.house'
          vault_token:
            type: javascript
            expr: wmill.getVariable('vault_terraform_token')
        path: f/terraform/terraform_apply
        skip_if:
          expr: 'results[''terraform-plan''].has_changes == false'
          label: Skip if no changes
    - id: notify-success
      value:
        type: script
        input_transforms:
          approval_message_id:
            type: javascript
            expr: 'results[''notify-approval'']?.message_id'
          details:
            type: static
            value: Terraform apply completed successfully
          discord:
            type: javascript
            expr: wmill.getResource('f/bots/terraform_discord_bot_configuration')
          discord_bot_token:
            type: javascript
            expr: >-
              wmill.getResource('f/bots/terraform_discord_bot_token_configuration')
          module:
            type: static
            value: tf/vault
          status:
            type: static
            value: success
        path: f/terraform/notify_status
        skip_if:
          expr: 'results[''terraform-plan''].has_changes == false'
          label: Skip if no changes
  failure_module:
    id: notify-failure
    value:
      type: script
      input_transforms:
        approval_message_id:
          type: javascript
          expr: 'results[''notify-approval'']?.message_id'
        details:
          type: javascript
          expr: error.message
        discord:
          type: javascript
          expr: wmill.getResource('f/bots/terraform_discord_bot_configuration')
        discord_bot_token:
          type: javascript
          expr: >-
            wmill.getResource('f/bots/terraform_discord_bot_token_configuration')
        module:
          type: static
          value: tf/vault
        status:
          type: static
          value: failed
      path: f/terraform/notify_status
schema: null
